{% extends "base.html" %}

{% block title %}MServe Service{% endblock %}

{% block script %}
<script type="text/javascript" src="/mservemedia/js/jquery-dateplustimepicker.min.js"></script>
{% endblock %}

{% block style %}
<style type="text/css">
#mfoldertreecontainer li { min-height:22px; line-height:22px; }
#mfoldertreecontainer a { line-height:20px; height:20px; font-size:10px; }
#mfoldertreecontainer a ins { height:20px; width:20px; background-position:-56px -17px; }

#mfoldertreecontainer1 li.mfile { min-height:122px; line-height:122px;}
#mfoldertreecontainer1 li.mfile a { line-height:120px; height:120px; font-size:10px;}
#mfoldertreecontainer1 li.mfile a ins { height:120px; width:208px; background-position: center; }
</style>
{% endblock %}

{% block usages %}
    <span>Number of Files:&nbsp;&nbsp;<em>{{service.mfile_set.all|length}}</em>&nbsp;&nbsp;&nbsp;</span>
    <span>Number of Jobs:&nbsp;&nbsp;<em>{{service.jobs|length}}</em>&nbsp;&nbsp;&nbsp;</span>
    {% if usagesummary %}
            {% for usagesummary in usagesummary %}
                {% if usagesummary.metric == "http://mserve/disc_space" %}
                            <span>Largest File:&nbsp;&nbsp;<em>{{usagesummary.max|filesizeformat}}</em>&nbsp;&nbsp;&nbsp;</span>
                            <span>Average File Size:&nbsp;&nbsp;<em>{{usagesummary.avg|filesizeformat}}</em>&nbsp;&nbsp;&nbsp;</span>
                            <span>Disc Space Used:&nbsp;&nbsp;<em>{{usagesummary.sum|filesizeformat}}</em>&nbsp;&nbsp;&nbsp;</span>
                {% endif %}
                {% if usagesummary.metric == "http://mserve/responsetime" %}
                    <span>Average Response Time&nbsp;&nbsp;<em>{{usagesummary.avg|floatformat}}s</em>&nbsp;&nbsp;&nbsp;</span>
                {% endif %}

            {% endfor %}
    {% endif %}
{% endblock %}

{% block main_img %}

<div id="dropbox" style="overflow:hidden;height: 164px;" >

    <div style="width: 266px; height:57px">
        <form id="file_upload" action="/services/{{service.id}}/mfiles/"
              method="POST" enctype="multipart/form-data"
              style="width: 100%;height: 100%;" >
            <input type="hidden" value="{{service.id}}" name="sid" />
                <input type="file" name="file" multiple>
                <button>Upload</button>
                <div class="file_upload_label"><h4>Drop Files Here</h4></div>
        </form>
    </div>

    <div id="files" style="width: 266px; height:97px; overflow: auto; margin-top: 4px;"  >
        <h4>In Progress</h4>
    </div>

</div>

{% endblock %}

{% block content %}

<div class="demo">

<div id="tabs">
	<ul>
		<li><a href="#tabs-1">Files</a></li>
		<li><a href="#jobs-tab">Jobs</a></li>
                <li><a href="#subservice-tab">Sub Services</a></li>
		<li><a href="#tabs-4">Config</a></li>
		<li><a href="#tabs-usage">Usage</a></li>
		<li><a href="#tabs-6">Access Control</a></li>
	</ul>

	<div id="tabs-1">

            <div id="mfoldertree" style="min-height: 500px">
            <div style="display: none" id="mfolderhiddencontainer"></div>
            <table style="table-layout: fixed;width: 100%;" border="0">
                    <tr>
                        <td style="width: 20%"><div id="mfoldertreecontainer"></div></td>
                        <td style="width: 60%"> <ul id="qscontainer" ></ul></td>
                    </tr>
                </table>
            </div>

            <ul id="mfilecontainer" style="display: block"></ul>

            <div class="paginator" id="mfilepaginator"></div>
            <div id="mfilemessages"></div>

            <ul id="managedresourcesmfilescontent" style="display: block" ></ul>

            <div class="clr"></div>

            <ul id="mfoldercontainer" style="display: block"></ul>


            <div class="clr"></div>



            <div class="clr"></div>

        </div>

    	<div id="subservice-tab">

            <table>
                <tr>
                    <th>New Service</th>
                    <th>Existing Services</th>
                </tr>
                <tr>
                    <td style="width: 25%">

                        <form id="subservice-form" style="width: 200px;height: 100%;" >
                               {{ subserviceform.as_p }}
                        </form>
                        <button id="subservice-button">New Service</button>

                    </td>
                    <td style="width: 65%">
                                <div id="subservicecontainer"></div>
                    </td>
                </tr>
            </table>


            <script type="text/javascript">
                $(document).ready(function() {

                    $.ajax({
                            type: "GET",
                            url: '{{service.subservices_url}}',
                            success: function(subservices){
                                $("#serviceTemplate").tmpl(subservices).appendTo("#subservicecontainer")
                            }
                    });

                    now = new Date()
                    $('#id_starttime').dateplustimepicker({
                        dateFormat: 'yy-mm-dd',
                        timeFormat: 'hh:mm:ss',
                        stepHour: 1,
                        stepMinute: 15,
                        numberOfMonths: 1,
                        step: { minutes: 15 },
                        show: 'fold',
                        showButtonPanel: true,
                        defaultTime: now
                    });
                    $('#id_starttime').dateplustimepicker("setTime",now);

                    oneHour = new Date()
                    oneHour.addHours(1)
                    $('#id_endtime').dateplustimepicker({
                        dateFormat: 'yy-mm-dd',
                        timeFormat: 'hh:mm:ss',
                        stepHour: 1,
                        stepMinute: 15,
                        numberOfMonths: 1,
                        step: { minutes: 15 },
                        show: 'fold',
                        showButtonPanel: true,
                        defaultTime: oneHour
                    });
                    $('#id_endtime').dateplustimepicker("setTime",oneHour);

                    $("#subservice-button").button().click(function(){
                        data = $("#subservice-form").serialize()
                        $.ajax({
                            type: "POST",
                            data: data,
                            url: '{{service.subservices_url}}',
                            success: function(subservice){
                                $("#serviceTemplate").tmpl(subservice).appendTo("#subservicecontainer")
                            }
                        });
                    })
                });
            </script>

        <div class="clr"></div>

        </div>

        <div id="jobs-tab">
             <h3>Jobs</h3>

            <div id="jobspaginator">
                <div class="spinner"><span class="red">Loading Jobs...</span></div>
            </div>

            <script type="text/javascript">
                $(document).ready(function() {
                    //loadMFiles('{{service.id}}');
                    loadJobs('{{service.id}}');
                    loadMFolders('{{service.id}}');
                });
            </script>

        </div>
       <div id="tabs-4">
           <h2>Properties</h2>

           <table>
               <tr>
                   <td>
                          <dl style="padding-left: 40px;">
                            <dt>Start Time</dt>
                            <dd>
                                {% if service.starttime %}
                                    {{service.starttime|date}} {{service.starttime|time}}
                                {% else %}
                                    <strong>No Start Time</strong>
                                {% endif %}
                            </dd>
                            <dt>End Time</dt>
                            <dd>
                                {% if service.endtime %}
                                    {{service.endtime|date}} {{service.endtime|time}}
                                {% else %}
                                    <strong>No End Time</strong>
                                {% endif %}
                            </dd>
                        </dl>

                   </td>
                   <td>
                       <div style="padding-left: 40px;">
                            <div style="padding: 10px;" id="prioritymessage"></div>
                            <button style="margin: 10px;" id="lowprioritybutton">Set to Low</button>
                            <button style="margin: 10px;" id="highprioritybutton">Set to High</button>

                       </div>
                   </td>
               </tr>
           </table>


            <h2>Access </h2>
            <dl style="padding-left: 40px;">
                <dt>WebDAV</dt>
                <dd>
                        <strong><span id="webdav"></span></strong>
                </dd>
            </dl>


            <h2>Management Properties</h2>

            <table id="managementpropertyholder" style="vertical-align: middle;padding:20px;padding-left: 40px;" >
                <tr><th>Name</th><th>Current Value</th><th></th><th>New Value</th><th></th><th></th></tr>

            </table>

            <h2>Profile Configuration</h2>

            <div id="profilepaginator">

            </div>

            <script type="text/javascript">
                $(document).ready(function() {
                    service_loadmanagementproperties('{{service.id}}');
                    service_loadprofiles('{{service.id}}');
                });
            </script>

            
     </div>
    <div id="tabs-usage">
            {% include "usage.html" %}
     </div>
    	<div id="tabs-6">
            {% include "auths.html" %}
     </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    $(function() {
        $( "#tabs" ).tabs();
        $("#webdav").text("dav://"+window.location.hostname+"/webdav/"+"{{service.id}}"+"/")
    });
});

hpmessage = "This service is in high priority"
lpmessage = "This service is in low priority"

function set_high_priority(){
    update_service_priority('{%url dataservice service.id%}',true)
    $("#highprioritybutton").hide()
    $("#lowprioritybutton").show()
    $("#prioritymessage").empty()
    $("#strongMessageTemplate" ).tmpl( {"message": hpmessage  } ).appendTo("#prioritymessage")
}
function set_low_priority(){
    update_service_priority('{%url dataservice service.id%}',false)
    $("#lowprioritybutton").hide()
    $("#highprioritybutton").show()
    $("#prioritymessage").empty()
    $( "#messageTemplate" ).tmpl( {"message": lpmessage  } ).appendTo("#prioritymessage")
}


$("#lowprioritybutton").button().click(set_low_priority)
$("#highprioritybutton").button().click(set_high_priority)
</script>

{% if service.priority %}
<script type="text/javascript">
       $(document).ready(function() {
            $( "#strongMessageTemplate" ).tmpl( {"message": hpmessage   } ).appendTo("#prioritymessage")
            $("#highprioritybutton").hide()
       });
    </script>
{% else %}
    <script type="text/javascript">
       $(document).ready(function() {
            $("#messageTemplate" ).tmpl( {"message": lpmessage  } ).appendTo("#prioritymessage")
            $("#lowprioritybutton").hide()
       });
    </script>
{% endif %}

</div><!-- End demo -->


<div style="clear:both"></div>

{% endblock %}

{% block rightcontent %}

{% endblock %}

{% block bottomcontent %}

{% endblock %}

